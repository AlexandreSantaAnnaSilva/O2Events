{% extends "base.html" %}

{% block title %}Detalhes: {{ evento.nome }}{% endblock %}

{% block content %}
<div class="row">
    
    <!-- Coluna de Detalhes do Evento e Resumo (COLUNA ESQUERDA) -->
    <div class="col-lg-4 mb-4">
        <div class="card shadow-lg rounded-4 h-100">
            <div class="card-header bg-dark text-white rounded-top-4 d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="bi bi-calendar-event me-2"></i> Detalhes do Evento</h4>
                <div>
                    <!-- Botão para abrir o Modal de Edição -->
                    <button class="btn btn-sm btn-outline-light me-2" data-bs-toggle="modal" data-bs-target="#modalEditarEvento">
                        <i class="bi bi-pencil-square"></i> Editar
                    </button>
                    <!-- Botão para Excluir (aciona modal de confirmação) -->
                    <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#modalExcluirEvento">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <h5 class="card-title fw-bold text-primary">{{ evento.nome }}</h5>
                <hr>
                <p class="card-text mb-2">
                    <i class="bi bi-calendar-check text-secondary me-2"></i> 
                    <span class="fw-bold">Data:</span> 
                    {{ evento.data_evento.strftime('%d/%m/%Y') if evento.data_evento else 'Não informada' }}
                </p>
                <p class="card-text mb-2">
                    <i class="bi bi-geo-alt-fill text-secondary me-2"></i> 
                    <span class="fw-bold">Local:</span> 
                    {{ evento.local if evento.local else 'Não informado' }}
                </p>
                <!-- Destaque para o Total Gasto -->
                <div class="mt-3 p-3 bg-light rounded-3 shadow-sm d-flex justify-content-between align-items-center">
                    <span class="fw-bold text-dark"><i class="bi bi-currency-dollar me-2"></i> Total Gasto:</span>
                    <span class="badge bg-danger fs-6 p-2">R$ {{ '{:,.2f}'.format(total_gasto) }}</span>
                </div>

            </div>
            
            <!-- Resumo de Pagamentos -->
            <div class="card-footer bg-light rounded-bottom-4">
                <h6 class="fw-bold text-dark mb-3"><i class="bi bi-people-fill me-1"></i> Resumo de Quem Pagou</h6>
                {% if quem_pagou_resumo %}
                    <ul class="list-group list-group-flush border-0">
                        {% for pagador, valor in quem_pagou_resumo.items() %}
                            <li class="list-group-item d-flex justify-content-between align-items-center p-2 bg-light">
                                {{ pagador }}
                                <span class="badge bg-secondary rounded-pill">R$ {{ '{:,.2f}'.format(valor) }}</span>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted fst-italic">Nenhuma nota cadastrada ainda.</p>
                {% endif %}
                <button class="btn btn-sm btn-outline-secondary w-100 mt-3" disabled><i class="bi bi-calculator me-1"></i> Ver Rateio (Em Breve)</button>
            </div>
        </div>
    </div>

    <!-- Coluna de Cadastro e Lista de Notas (COLUNA DIREITA) -->
    <div class="col-lg-8">
        
        <!-- Exibição de Flash Messages (se houver) -->
        <!-- NOTA: O bloco de flash messages foi movido para o templates/base.html para consistência. -->
        
        <!-- CARD PARA ADICIONAR NOVA NOTA (Re-inserido) -->
        <div class="card shadow-lg border-primary border-3 rounded-4 mb-4">
            <div class="card-header bg-primary text-white rounded-top-4 p-3">
                <h4 class="mb-0 text-center"><i class="bi bi-receipt-cutoff me-2"></i> Adicionar Nova Despesa (Nota)</h4>
            </div>
            <div class="card-body p-4">
                <form method="POST" action="{{ url_for('detalhes_evento', evento_id=evento.id) }}" enctype="multipart/form-data">
                    <div class="row g-3">
                        <div class="col-md-12 mb-3">
                            <label for="descricao" class="form-label fw-bold">Descrição da Despesa</label>
                            <input type="text" class="form-control rounded-3" id="descricao" name="descricao" required placeholder="Ex: Cerveja e Petiscos">
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="valor" class="form-label fw-bold">Valor (R$)</label>
                            <!-- Usando type="text" com pattern para garantir compatibilidade com ponto ou vírgula -->
                            <input type="text" class="form-control rounded-3" id="valor" name="valor" required placeholder="0.00" pattern="[0-9]+([,\.][0-9]{1,2})?">
                            <div class="form-text">Use ponto ou vírgula para centavos.</div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="quem_pagou" class="form-label fw-bold">Quem Pagou?</label>
                            <input type="text" class="form-control rounded-3" id="quem_pagou" name="quem_pagou" required placeholder="Seu Nome">
                        </div>

                        <div class="col-md-12 mb-4">
                            <label for="arquivo" class="form-label fw-bold">Nota Fiscal / Comprovante (Opcional)</label>
                            <input class="form-control rounded-3" type="file" id="arquivo" name="arquivo" accept=".pdf,image/*">
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg rounded-3 fw-bold shadow-sm">
                            <i class="bi bi-plus-circle-fill me-2"></i> Adicionar Despesa
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- LISTA DE NOTAS CADASTRADAS (Sua Tabela Aprimorada) -->
        <div class="card shadow-lg rounded-4">
            <div class="card-header bg-dark text-white rounded-top-4">
                <h4 class="mb-0"><i class="bi bi-receipt-cutoff me-2"></i> Notas Fiscais (Total: {{ notas|length }})</h4>
            </div>
            <div class="card-body p-0">
                {% if notas %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th scope="col">Descrição</th>
                                <th scope="col" class="text-center">Pagador</th>
                                <th scope="col" class="text-end">Valor (R$)</th>
                                <th scope="col" class="text-center">Anexo</th>
                                <th scope="col" class="text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Exibindo as notas mais recentes primeiro -->
                            {% for nota in notas | reverse %}
                            <tr>
                                <td>
                                    {{ nota.descricao }}
                                    <div class="text-muted small mt-1">
                                        <i class="bi bi-clock me-1"></i> {{ nota.data_cadastro.strftime('%d/%m/%Y %H:%M') }}
                                    </div>
                                </td>
                                <td class="text-center">{{ nota.quem_pagou }}</td>
                                <!-- Usando o formato de moeda que você definiu -->
                                <td class="text-end fw-bold text-success">R$ {{ '{:,.2f}'.format(nota.valor) }}</td> 
                                <td class="text-center">
                                    {% if nota.caminho_arquivo %}
                                        <!-- Rota para download do arquivo -->
                                        <a href="{{ url_for('uploaded_file', filename=nota.caminho_arquivo) }}" class="btn btn-sm btn-info" title="Baixar Anexo">
                                            <i class="bi bi-download"></i>
                                        </a>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <!-- Botão de Excluir Nota -->
                                    <form action="{{ url_for('excluir_nota', nota_id=nota.id) }}" method="POST" onsubmit="return confirm('Tem certeza que deseja excluir esta nota fiscal?');" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Excluir Nota">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                    <div class="p-4 text-center">
                        <p class="text-muted fst-italic mb-0">Nenhuma nota fiscal cadastrada para este evento.</p>
                        <!-- Agora o formulário está logo acima, então este link é menos crítico -->
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- ======================================================= -->
<!-- MODAL DE EDIÇÃO DO EVENTO -->
<!-- ======================================================= -->
<div class="modal fade" id="modalEditarEvento" tabindex="-1" aria-labelledby="modalEditarEventoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg">
            <div class="modal-header bg-dark text-white rounded-top-4">
                <h5 class="modal-title" id="modalEditarEventoLabel"><i class="bi bi-pencil-square me-2"></i> Editar Detalhes do Evento</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('editar_evento', evento_id=evento.id) }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nome_evento" class="form-label fw-bold">Nome do Evento</label>
                        <input type="text" class="form-control rounded-3" id="nome_evento" name="nome_evento" 
                               value="{{ evento.nome }}" required maxlength="100">
                    </div>
                    <div class="mb-3">
                        <label for="data_evento" class="form-label fw-bold">Data do Evento (Opcional)</label>
                        <input type="date" class="form-control rounded-3" id="data_evento" name="data_evento" 
                               value="{{ evento.data_evento.strftime('%Y-%m-%d') if evento.data_evento else '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="local" class="form-label fw-bold">Local do Evento (Opcional)</label>
                        <input type="text" class="form-control rounded-3" id="local" name="local" 
                               value="{{ evento.local if evento.local else '' }}" maxlength="100">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary"><i class="bi bi-save-fill me-2"></i> Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ======================================================= -->
<!-- MODAL DE CONFIRMAÇÃO DE EXCLUSÃO DO EVENTO -->
<!-- ======================================================= -->
<div class="modal fade" id="modalExcluirEvento" tabindex="-1" aria-labelledby="modalExcluirEventoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-danger border-3">
            <div class="modal-header bg-danger text-white rounded-top-4">
                <h5 class="modal-title" id="modalExcluirEventoLabel"><i class="bi bi-exclamation-triangle-fill me-2"></i> Confirmação de Exclusão</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir o evento **{{ evento.nome }}**?</p>
                <p class="text-danger fw-bold">ATENÇÃO: Todas as notas fiscais associadas e seus arquivos serão permanentemente excluídos.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form action="{{ url_for('excluir_evento', evento_id=evento.id) }}" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-danger"><i class="bi bi-trash-fill me-2"></i> Excluir Evento Permanentemente</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}